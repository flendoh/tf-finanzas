<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_dossier">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <div class="page">
                        <h2 class="text-center">Cronograma de Pagos - Simulación de Escenario</h2>
                        
                        <!-- Información General -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Expediente:</strong></td>
                                        <td><span t-field="doc.name"/></td>
                                        <td><strong>Cliente:</strong></td>
                                        <td><span t-field="doc.cliente_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Proyecto:</strong></td>
                                        <td><span t-field="doc.proyecto_id.name"/></td>
                                        <td><strong>Entidad Financiera:</strong></td>
                                        <td><span t-field="doc.producto_financiero_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Valor Vivienda:</strong></td>
                                        <td><span t-field="doc.valor_vivienda" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                        <td><strong>Cuota Inicial:</strong></td>
                                        <td><span t-field="doc.cuota_inicial" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Monto a Financiar:</strong></td>
                                        <td><span t-field="doc.monto_a_financiar" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                        <td><strong>Plazo (meses):</strong></td>
                                        <td><span t-field="doc.plazo_meses"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>TEA:</strong></td>
                                        <td><span t-esc="'{:.2f} %'.format(doc.tea * 100)"/></td>
                                        <td><strong>Cuota Mensual:</strong></td>
                                        <td><span t-field="doc.cuota_mensual" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Cronograma de Pagos -->
                        <div class="row mt-5">
                            <div class="col-12">
                                <h3>Cronograma de Pagos</h3>
                                <table class="table table-sm table-bordered">
                                    <thead class="thead-light">
                                        <tr>
                                            <th class="text-center">Período</th>
                                            <th class="text-center">Saldo Inicial</th>
                                            <th class="text-center">Amortización</th>
                                            <th class="text-center">Intereses</th>
                                            <th class="text-center">Seg. Desgravamen</th>
                                            <th class="text-center">Seg. Inmueble</th>
                                            <th class="text-center">Cuota Total</th>
                                            <th class="text-center">Saldo Final</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="doc.lineas_cronograma_cuota_ids" t-as="linea">
                                            <tr>
                                                <td class="text-center"><span t-field="linea.periodo"/></td>
                                                <td class="text-right"><span t-field="linea.saldo_inicial" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                                <td class="text-right"><span t-field="linea.amortizacion" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                                <td class="text-right"><span t-field="linea.intereses" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                                <td class="text-right"><span t-field="linea.seguro_desgravamen" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                                <td class="text-right"><span t-field="linea.seguro_inmueble" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                                <td class="text-right">
                                                    <t t-set="cuota_total" t-value="linea.amortizacion + linea.intereses + linea.seguro_desgravamen + linea.seguro_inmueble"/>
                                                    <span t-esc="cuota_total" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/>
                                                </td>
                                                <td class="text-right"><span t-field="linea.saldo_final" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Resumen -->
                        <div class="row mt-4">
                            <div class="col-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Total Amortización:</strong></td>
                                        <td class="text-right">
                                            <t t-set="total_amortizacion" t-value="sum(linea.amortizacion for linea in doc.lineas_cronograma_cuota_ids)"/>
                                            <span t-esc="total_amortizacion" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Intereses:</strong></td>
                                        <td class="text-right">
                                            <t t-set="total_intereses" t-value="sum(linea.intereses for linea in doc.lineas_cronograma_cuota_ids)"/>
                                            <span t-esc="total_intereses" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Seguros:</strong></td>
                                        <td class="text-right">
                                            <t t-set="total_seguros" t-value="sum(linea.seguro_desgravamen + linea.seguro_inmueble for linea in doc.lineas_cronograma_cuota_ids)"/>
                                            <span t-esc="total_seguros" t-options="{'widget': 'monetary', 'display_currency': doc.moneda_id}"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>TCEA:</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:.2f} %'.format(doc.tcea * 100)"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Notas -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <p class="text-muted text-center">
                                    Este cronograma es una simulación y puede estar sujeta a cambios según condiciones del mercado.
                                </p>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>